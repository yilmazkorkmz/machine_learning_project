import os
import keras
import math
import gc
import tensorflow as tf
import numpy as np
import scipy.io as sio
import keras.backend as K
from keras.models import Sequential, Model
from keras.layers import Dense, MaxPooling2D, Conv2D, Flatten, Dropout, TimeDistributed, LSTM, Input, Reshape, Activation, MaxPool2D, BatchNormalization
from keras.layers.merge import concatenate
from keras.utils import np_utils
import matplotlib.pyplot as plt
from sklearn.model_selection import StratifiedKFold
from sklearn.model_selection import train_test_split
from keras.models import model_from_json
from sklearn.metrics import confusion_matrix, roc_curve, auc

#The method that creates a model with given parameters
def create_mdl(lr=0.001, act='relu', c1=48):
    
    print('learning rate is: %s' % str(lr))
    print ('activation func: %s' % str(act))

    model = None
#    model=Sequential();                          
#
#    model.add(Conv2D(c1, (5, 5), strides=(1,1), input_shape=(150,200,3)))
##    model.add(BatchNormalization())
#    model.add(Activation(act))
#    
# 
#    model.add(Conv2D(16, (5, 5), strides=(1,1)))
##    model.add(BatchNormalization())
#    model.add(Activation(act))
#
##   model.add(Conv2D(8, (3, 3), strides=(1,2)))
##    model.add(BatchNormalization())
##    model.add(Activation(act))
#    model.add(MaxPooling2D((2,2), strides=(2,2)))
#    model.add(Flatten())
#
##    model.add((Dense(200, activation=act))) #Dense: fully-connected
#
##    model.add(Dropout(0.5))
#    model.add((Dense(7, activation="softmax")))
#
#    my_opt = keras.optimizers.Adam(lr=lr)
#    
#    model.compile(loss='categorical_crossentropy',optimizer=my_opt,metrics=['accuracy'])
#
#    model.summary()
#    return model
    model = Sequential()
    model.add(Conv2D(32, kernel_size=(3, 3),activation='relu',padding = 'Same',input_shape=(75,100,3)))
    model.add(Conv2D(32,kernel_size=(3, 3), activation='relu',padding = 'Same',))
    model.add(MaxPool2D(pool_size = (2, 2)))
    model.add(Dropout(0.25))
    
    model.add(Conv2D(64, (3, 3), activation='relu',padding = 'Same'))
    model.add(Conv2D(64, (3, 3), activation='relu',padding = 'Same'))
    model.add(MaxPool2D(pool_size=(2, 2)))
    model.add(Dropout(0.40))
    
    model.add(Flatten())
    model.add(Dense(128, activation='relu'))
    model.add(Dropout(0.5))
    model.add(Dense(7, activation='softmax'))
    
    
    optimizer = keras.optimizers.Adam(lr=0.001, beta_1=0.9, beta_2=0.999, epsilon=None, decay=0.0, amsgrad=False)
    model.compile(loss='categorical_crossentropy',optimizer=optimizer,metrics=['accuracy'])
    
    model.summary()
    return model

X_train = np.load('X_train.npy')
Y_train = np.load('Y_train.npy')
X_test = np.load('X_test.npy')
Y_test = np.load('Y_test.npy')

# Initialize the model
lr = 0.001
act = "relu"
my_batch = 100
my_epoch = 10
model = create_mdl(lr=lr, act=act)
# Train
history = model.fit(X_train, Y_train, batch_size=my_batch, epochs=my_epoch, verbose=2)
# Test
score = model.evaluate(X_test, Y_test, verbose=1)  
print(score)

#model.predict
